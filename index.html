<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SipMap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <nav class="top-nav">
            <div class="brand">
                <span class="logo">üó∫Ô∏è</span>
                <h1>SipMap</h1>
            </div>
            <div class="nav-actions">
                <button onclick="showSaved()" class="nav-btn saved-btn" title="Saved Places">
                    <i class="fas fa-bookmark"></i>
                </button>
            </div>
        </nav>

        <div class="main-content">
            <div class="search-container">
                <div class="search-interface">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="locationSearch" placeholder="Find cafes in any city...">
                        <button onclick="searchByText()" class="action-button search-btn">
                            <i class="fas fa-compass"></i>
                        </button>
                    </div>
                    <div class="action-buttons">
                        <button onclick="getLocationCachedOrNew()" class="action-button location-btn">
                            <i class="fas fa-location-dot"></i>
                            <span>Near Me</span>
                        </button>
                        <button onclick="showSaved()" class="action-button saved-btn">
                            <i class="fas fa-bookmark"></i>
                            <span>Saved</span>
                        </button>
                        <button onclick="clearSaved()" class="action-button clear-btn">
                            <i class="fas fa-trash-can"></i>
                            <span>Clear Saved</span>
                        </button>
                    </div>
                    <div class="search-stats">
                        <span class="results-count"></span>
                        <button onclick="clearRejected()" class="text-button">
                            <i class="fas fa-rotate"></i> Reset Rejected
                        </button>
                    </div>
                </div>
            </div>

        <div class="cards"></div>
        <div class="saved-cafes" style="display: none;"></div>
    </div>

  <script>
    const API_BASE_URL = 'http://localhost:3000';

    async function searchByText() {
        const searchInput = document.getElementById('locationSearch');
        const query = searchInput.value.trim();
        
        if (!query) {
            showError("Please enter a location to search");
            return;
        }

        document.querySelector('.cards').style.display = 'block';
        document.querySelector('.saved-cafes').style.display = 'none';
        // Clear the saved container to prevent z-index issues
        document.querySelector('.saved-cafes').innerHTML = '';

        try {
            const response = await fetch(`${API_BASE_URL}/api/search-cafes?query=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.status === 'OK' && data.results && data.results.length > 0) {
                displayCards(data.results);
            } else {
                showError(`No cafes found in ${query}`);
            }
        } catch (e) {
            console.error("Error searching cafes:", e);
            showError("Error searching cafes. Please try again.");
        }
    }

    function getLocationCachedOrNew() {
        document.querySelector('.cards').style.display = 'block';
        document.querySelector('.saved-cafes').style.display = 'none';
        // Clear the saved container to prevent z-index issues
        document.querySelector('.saved-cafes').innerHTML = '';
        
        const cache = JSON.parse(localStorage.getItem('cachedLocation') || '{}');
        const now = Date.now();
        if (cache.timestamp && now - cache.timestamp < 10 * 60 * 1000) {
            useLocation(cache.lat, cache.lng);
        } else {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                localStorage.setItem('cachedLocation', JSON.stringify({ lat, lng, timestamp: now }));
                useLocation(lat, lng);
            }, () => showError("Location access denied or unavailable. Try searching by city name instead."));
        }
    }

    function showError(message) {
        const container = document.querySelector('.cards');
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #f44336; margin-bottom: 1rem;"></i>
                <p>${message}</p>
            </div>
        `;
    }

    async function useLocation(lat, lng) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/search-cafes?lat=${lat}&lng=${lng}`);
            const data = await response.json();
            if (data.status === 'OK' && data.results && data.results.length > 0) {
                displayCards(data.results);
            } else {
                showError("No cafes found in your area.");
            }
        } catch (e) {
            console.error("Error fetching cafes:", e);
            showError("Error fetching cafes. Please make sure the server is running.");
        }
    }

    // Add event listener for Enter key in search input
    document.getElementById('locationSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchByText();
        }
    });

    // Keep track of rejected cafe IDs
    let rejectedCafes = new Set(JSON.parse(localStorage.getItem('rejectedCafes') || '[]'));

    function displayCards(cafes) {
        const container = document.querySelector('.cards');
        container.innerHTML = '';
        
        // Filter out rejected cafes
        const filteredCafes = cafes.filter(cafe => !rejectedCafes.has(cafe.place_id));
        
        // Filter out already saved cafes
        const savedCafes = new Set(JSON.parse(localStorage.getItem('savedCafes') || '[]')
            .map(cafe => cafe.place_id));
        
        const availableCafes = filteredCafes.filter(cafe => !savedCafes.has(cafe.place_id));

        if (availableCafes.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-coffee" style="font-size: 3rem; color: #1e3d59; margin-bottom: 1rem;"></i>
                    <p>No more cafes to show in this area. Try searching in a different location!</p>
                </div>
            `;
            return;
        }

        availableCafes.forEach((cafe, i) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'swipe-wrapper';
            wrapper.style.zIndex = 200 - i;

            const card = document.createElement('div');
            card.className = 'location-card';
            card.dataset.placeId = cafe.place_id;

            const imgUrl = cafe.photo || 'https://via.placeholder.com/400x200?text=No+Image';

            const cafeData = {
                name: cafe.name,
                place_id: cafe.place_id,
                photo: imgUrl,
                rating: cafe.rating,
                address: cafe.address,
                priceLevel: cafe.priceLevel,
                type: cafe.type,
                description: cafe.description,
                openNow: cafe.openNow,
                websiteUri: cafe.websiteUri,
                internationalPhoneNumber: cafe.internationalPhoneNumber
            };

                card.innerHTML = `
                    <img src="${imgUrl}" alt="${cafe.name}" />
                    <div class="card-content">
                        <h3>${cafe.name}</h3>
                        <div class="card-details">
                            ${cafe.rating !== 'N/A' ? `<p class="rating"><i class="fas fa-star"></i> ${cafe.rating}</p>` : ''}
                            ${cafe.priceLevel !== 'N/A' ? `<p class="price-level">${getPriceLevelSymbols(cafe.priceLevel)}</p>` : ''}
                            ${cafe.openNow ? '<p class="open-now"><i class="fas fa-clock"></i> Open</p>' : ''}
                            ${cafe.type ? `<p class="place-type"><i class="fas fa-utensils"></i> ${cafe.type}</p>` : ''}
                        </div>
                        <p class="address"><i class="fas fa-map-marker-alt"></i> ${cafe.address}</p>
                        ${cafe.description ? `<p class="description">${cafe.description}</p>` : ''}
                        <div class="contact-info">
                            ${cafe.websiteUri ? `<a href="${cafe.websiteUri}" target="_blank" class="website-link"><i class="fas fa-globe"></i> Website</a>` : ''}
                            ${cafe.internationalPhoneNumber ? `<a href="tel:${cafe.internationalPhoneNumber}" class="phone-link"><i class="fas fa-phone"></i> ${cafe.internationalPhoneNumber}</a>` : ''}
                            <button class="map-button" onclick="openMap('${cafe.name}', '${cafe.address}')">
                                <i class="fas fa-map"></i> View on Map
                            </button>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="action-button reject-button" onclick="rejectCafe(this.parentElement.parentElement.parentElement)">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="action-button accept-button" data-cafe='${JSON.stringify(cafeData)}' onclick="acceptCafeFromButton(this)">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                    <div class="swipe-hint">
                        <p><small>Swipe right to save or use buttons below</small></p>
                    </div>
                `;

            wrapper.appendChild(card);
            container.appendChild(wrapper);

            const hammertime = new Hammer(wrapper);
            hammertime.on('swipeleft', () => rejectCafe(wrapper));
            hammertime.on('swiperight', () => acceptCafe(wrapper, cafeData));
        });
    }

    function rejectCafe(wrapper) {
        const placeId = wrapper.querySelector('.location-card').dataset.placeId;
        rejectedCafes.add(placeId);
        localStorage.setItem('rejectedCafes', JSON.stringify([...rejectedCafes]));
        
        wrapper.style.transform = 'translateX(-150%) rotate(-15deg)';
        wrapper.style.opacity = 0;
        setTimeout(() => {
            wrapper.remove();
            checkForEmptyState();
        }, 300);
    }

    function acceptCafeFromButton(button) {
        const cafeData = JSON.parse(button.getAttribute('data-cafe'));
        const wrapper = button.closest('.swipe-wrapper');
        acceptCafe(wrapper, cafeData);
    }

    function acceptCafe(wrapper, cafeData) {
        let saved = JSON.parse(localStorage.getItem('savedCafes') || '[]');
        // Strict equality check for duplicates using place_id
        const isDuplicate = saved.some(c => c.place_id === cafeData.place_id);
        
        if (!isDuplicate) {
            // Remove any potential duplicates first
            saved = saved.filter(c => c.place_id !== cafeData.place_id);
            // Then add the new cafe
            saved.push(cafeData);
            localStorage.setItem('savedCafes', JSON.stringify(saved));
            showToast(`${cafeData.name} saved! üíñ`);
        } else {
            showToast(`${cafeData.name} is already saved! üòä`);
        }
        
        wrapper.style.transform = 'translateX(150%) rotate(15deg)';
        wrapper.style.opacity = 0;
        setTimeout(() => {
            wrapper.remove();
            checkForEmptyState();
        }, 300);
    }

    function checkForEmptyState() {
        const container = document.querySelector('.cards');
        if (!container.querySelector('.swipe-wrapper')) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-coffee" style="font-size: 3rem; color: #1e3d59; margin-bottom: 1rem;"></i>
                    <p>No more cafes to show in this area. Try searching in a different location!</p>
                </div>
            `;
        }
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 1000;
            animation: fadeInOut 2s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    }

    function getPriceLevelSymbols(priceLevel) {
        switch(priceLevel) {
            case 'PRICE_LEVEL_FREE':
                return '<span title="Free">Free</span>';
            case 'PRICE_LEVEL_INEXPENSIVE':
                return '<span title="Inexpensive">$</span>';
            case 'PRICE_LEVEL_MODERATE':
                return '<span title="Moderate">$$</span>';
            case 'PRICE_LEVEL_EXPENSIVE':
                return '<span title="Expensive">$$$</span>';
            case 'PRICE_LEVEL_VERY_EXPENSIVE':
                return '<span title="Very Expensive">$$$$</span>';
            default:
                return '';
        }
    }

    function showSaved() {
        document.querySelector('.cards').style.display = 'none';
        // Clear the cards container to prevent z-index issues
        document.querySelector('.cards').innerHTML = '';
        const savedContainer = document.querySelector('.saved-cafes');
        savedContainer.style.display = 'grid';
        
        const saved = JSON.parse(localStorage.getItem('savedCafes') || '[]');
        if (saved.length === 0) {
            savedContainer.classList.add('empty');
            savedContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-heart-broken" style="font-size: 3rem; color: #f44336; margin-bottom: 1rem;"></i>
                    <p>No saved cafes yet. Start exploring!</p>
                </div>
            `;
            return;
        }

        savedContainer.classList.remove('empty');
        savedContainer.innerHTML = saved.map(cafe => `
            <div class="saved-card">
                <img src="${cafe.photo}" alt="${cafe.name}" />
                <div class="card-content">
                    <h3>${cafe.name}</h3>
                    <div class="card-details">
                        ${cafe.rating !== 'N/A' ? `<p class="rating"><i class="fas fa-star"></i> ${cafe.rating}</p>` : ''}
                        ${cafe.priceLevel !== 'N/A' ? `<p class="price-level">${getPriceLevelSymbols(cafe.priceLevel)}</p>` : ''}
                    </div>
                    <p class="address"><i class="fas fa-map-marker-alt"></i> ${cafe.address}</p>
                    <div class="saved-card-actions">
                        <button class="map-button" onclick="openMap('${cafe.name}', '${cafe.address}')">
                            <i class="fas fa-map"></i> View on Map
                        </button>
                    </div>
                    
                </div>
            </div>
        `).join('');
    }

    function clearSaved() {
        if (confirm('Are you sure you want to clear all saved cafes?')) {
            localStorage.removeItem('savedCafes');
            showToast('All saved cafes have been cleared! üóëÔ∏è');
            showSaved(); // Refresh the saved cafes view
        }
    }

    function clearRejected() {
        rejectedCafes.clear();
        localStorage.removeItem('rejectedCafes');
        // If we're currently showing cafes, refresh the view
        const query = document.getElementById('locationSearch').value.trim();
        if (query) {
            searchByText();
        } else {
            getLocationCachedOrNew();
        }
    }

    function openMap(name, address) {
        // Create Google Maps URL with the cafe name and address
        const query = encodeURIComponent(`${name}, ${address}`);
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${query}`;
        window.open(mapsUrl, '_blank');
    }

    // Add keyframe animation for toast
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, 20px); }
            15% { opacity: 1; transform: translate(-50%, 0); }
            85% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>